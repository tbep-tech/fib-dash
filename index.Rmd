---
title: "TAMPA BAY FIB DASHBOARD"
output: 
  flexdashboard::flex_dashboard:
    logo: www/tarponlogo.png
    social: menu
    source_code: "https://github.com/tbep-tech/fib-dash"
    # includes:
      # in_header: google-analytics.html
runtime: shiny
css: styles.css
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = F, message = F, warning = F)

source(here::here('R/global.R'))
source(here::here('R/funcs.R'))
# devtools::load_all('../tbeptools', helpers = F)
```

```{r reactives}
# baywide ent matrix
entmatrix <- reactive({

  # inputs
  areasel1 <- input$areasel1
  segsel1 <- input$segsel1
  yrsel1 <- input$yrsel1
  
  if(!segsel1){
    stas <- enterodata %>%
      dplyr::filter(bay_segment %in% areasel1) %>%
      dplyr::select(station) %>%
      dplyr::distinct() %>%
      dplyr::pull()

    p <- try(tbeptools::show_fibmatrix(enterodata, stas = stas, yrrng = c(NA, maxyr), indic = 'entero'))
  
  }
  
  if(segsel1){

    p <- try(tbeptools::show_fibmatrix(enterodata, stas = NULL, bay_segment = areasel1, yrrng = c(NA, maxyr), indic = 'entero'))
  
  }
  
  validate(
    need(!inherits(p, 'try-error'), 'No enterococcus data available for selection')
  )
  
  out <- mataddyr_fun(p, yrsel = yrsel1)
  
  return(out)
  
})

# data for baywide ent map, yr
yrtomap1 <- reactive({
  
  yrsel1 <- input$yrsel1
  areasel1 <- input$areasel1
  
  req(areasel1)
  
  out <- tbeptools::show_fibmatmap(enterodata, yrsel = yrsel1, areasel = areasel1, indic = 'entero', listout = T)
  
  return(out)
    
}) 

# baywide ent data to map, yr
observe({

  # inputs
  yrtomap1 <- try(yrtomap1())

  # create map
  if(inherits(yrtomap1, 'try-error'))
    leaflet::leafletProxy("entmapyr") %>%
      leaflet::clearMarkers() |> 
      leaflet::clearShapes()

  if(!inherits(yrtomap1, 'try-error'))
    leaflet::leafletProxy("entmapyr") %>%
      leaflet::clearMarkers() |>
      leaflet::clearShapes() |> 
      leaflet::addMarkers(
        data = yrtomap1$tomapsta,
        lng = ~Longitude,
        lat = ~Latitude,
        icon = ~yrtomap1$icons[as.numeric(cat)],
        label = ~lapply(as.list(lab), tbeptools::util_html)
      ) |> 
      leaflet::addPolygons(
        data = yrtomap1$tomapseg,
        fillColor = ~I(col),
        fillOpacity = 0.5,
        color = 'black',
        weight = 1,
        label = ~lapply(as.list(lab), tbeptools::util_html)
      )

})

# baywide ent data to map, yr mo
enterotomap <- reactive({

   # inputs
  yrsel1 <- input$yrsel1
  mosel1 <- input$mosel1
  areasel1 <- input$areasel1

  mosel1 <- mos[[mosel1]]
  areasel <- names(areas1[areas1 %in% areasel1])
  
  tomap <- tbeptools::anlz_enteromap(enterodata, yrsel1, mosel1, areasel, wetdry = TRUE, precipdata = catchprecip, 
                                     temporal_window = 2, wet_threshold = 0.5, assf = T)

  return(tomap)

})

observe({

  # inputs
  enterotomap <- try(enterotomap())

  # create map
  if(inherits(enterotomap, 'try-error'))
    leaflet::leafletProxy("entmap", data = enterotomap) %>%
      leaflet::clearMarkers()

  if(!inherits(enterotomap, 'try-error'))
    leaflet::leafletProxy("entmap", data = enterotomap) %>%
      leaflet::clearMarkers() |>
      leaflet::addMarkers(
        data = enterotomap,
        lng = ~Longitude,
        lat = ~Latitude,
        icon = ~ecocciicons[as.numeric(grp)],
        label = ~lapply(as.list(lab), tbeptools::util_html)
      )

})

# epc fib matrix
fibmatrix <- reactive({

  # inputs
  areasel2 <- input$areasel2
  yrsel2 <- input$yrsel2
  
  stas <- fibdata %>%
    dplyr::filter(area %in% areasel2) %>%
    dplyr::select(epchc_station) %>%
    dplyr::distinct() %>%
    dplyr::pull()

  p <- try(tbeptools::show_fibmatrix(fibdata, stas = stas, yrrng = c(NA, maxyr), indic = 'fcolif'))
  
  validate(
    need(!inherits(p, 'try-error'), 'No fecal coliform data available for selection')
  )
  
  out <- mataddyr_fun(p, yrsel = yrsel2)
    
  return(out)
  
})

# epc fib data to map
fibtomap <- reactive({

  # inputs
  yrsel2 <- input$yrsel2
  mosel2 <- input$mosel2
  areasel2 <- input$areasel2

  mosel2 <- mos[[mosel2]]
  
  tomap <- tbeptools::anlz_fibmap(fibdata, yrsel2, mosel2, areasel2, assf = T)
  
  return(tomap)
  
})

fibmap <- leaflet::leafletProxy('fibmap')

# epc fib map
observe({

  # inputs
  fibtomap <- try(fibtomap())

  # create map
  if(inherits(fibtomap, 'try-error'))
    fibmap %>%
      leaflet::clearMarkers()
  
  if(!inherits(fibtomap, 'try-error'))
    fibmap %>%
      leaflet::clearMarkers() |> 
      leaflet::addMarkers(
        data = fibtomap,
        lng = ~Longitude,
        lat = ~Latitude,
        icon = ~fibicons[as.numeric(grp)],
        label = ~lapply(as.list(lab), tbeptools::util_html)
      )
    
})
```

```{r output}
# baywide ent matrix
output$entmatrix <- plotly::renderPlotly(entmatrix())

# baywide ent map, yr
output$entmapyr <- leaflet::renderLeaflet({

  tbeptools::show_fibmatmap(enterodata, yrsel = maxyr, 
                            areasel = c('OTB', 'HB', 'MTB', 'LTB', 'BCB', 'MR'),
                            precipdata = catchprecip, indic = 'entero')

})

# baywide ent map, yr mo
output$entmap <- leaflet::renderLeaflet({

  tbeptools::show_enteromap(enterodata, yrsel = maxyr, mosel = 7, areasel = c('Hillsborough Bay', 'Old Tampa Bay', 'Middle Tampa Bay', 'Lower Tampa Bay', 'Boca Ciega Bay', 'Manatee River'),
                            wetdry = T, precipdata = catchprecip, temporal_window = 2, wet_threshold = 0.5)

})

# epc fib matrix
output$fibmatrix <- plotly::renderPlotly(fibmatrix())

# epc fib map
output$fibmap <- leaflet::renderLeaflet({

  tbeptools::show_fibmap(fibdata, yrsel = maxyr, mosel = 7, areasel = c('Alafia River', 'Hillsborough River'))

})
```

```{r downloadhandlers}
# # download transect table
# output$dwnld <- downloadHandler(
#   filename = function(){'benthicdata.csv'},
#   content = function(file){
#     
#     # inputs
#     dldat <- dldat()
#     
#     write.csv(dldat, file, quote = T, row.names = F)
#     
#   }
# )
```

OVERVIEW
===========================================================

Column {.tabset .tabset-fade data-width=650}
-----------------------------------------------------------------------

### USING THE DASHBOARD

<div class = "row">
<div class = "col-md-2"></div>
<div class = "col-md-8">

#### WELCOME TO THE TAMPA BAY FIB DASHBOARD!

```{r, echo = F, out.width = '100%', fig.align = 'center'}
# knitr::include_graphics('www/bannerimage.png')
```

This dashboard summarizes fecal indicator bacteria (FIB) data for a baywide assessment and for data collected as part of the Environmental Protection Commission of Hillsborough County (EPCHC) monitoring program.  The latter is specific to evaluating fecal impairments in the Hillsborough and Alafia river basins.  The assessments are meant to inform progress remediating fecal impairments or to support prioritization of areas for further investigation. They are not meant to support beach monitoring efforts or closures for recreational uses - alternative reporting products are available for that purpose (see [FLDOH Healthy Beaches](https://www.floridahealth.gov/environmental-health/beach-water-quality/county-detail.html?County=Pinellas&Zip=33701-3109){target="_blank"}). The dashboard is organized in the following sections:

1) [__BAYWIDE__](#baywide): View baywide summaries of *Enterococcus* data at select monitoring locations for each bay segment
1) [__EPCHC__](#epchc): View summaries of EPCHC FIB data for the Hillsborough and Alafia river basins
1) [__DATA DOWNLOADS__](#data-downloads): Download baywide *Enterococcus* or EPCHC FIB data

The plots in this dashboard are interactive and display options can be controlled using a mouse. Most plots include a [control menu](https://help.plot.ly/zoom-pan-hover-controls/){target="_blank"} on the top with different options for viewing the data.  For example, click the camera icon to download a plot.

<br>
```{r, fig.align='center', out.width='30%'}
knitr::include_graphics('www/plotcontrols.PNG')
```
<br>

#### Data sources

Source data used on this website were obtained from multiple sources for the baywide assessment and from the Environmental Protection Commission of Hillsborough County. Data can be obtained using functions from the tbeptools R package described below. Graphics and tables provided on the dashboard are made available for exploratory purposes only.  

#### Website information

<a href="https://tbep-tech.github.io/tbeptools/articles/tbbi.html" target="__blank" rel="noopener noreferrer"><img class="wp-image-14010 alignnone " src="www/tbeptoolshex.png" alt="" width="200" height="200" /></a>

The page source content can be viewed on [Github](https://github.com/tbep-tech/fib-dash){target="_blank"}. Nearly all of the data, tables, and plots were created using functions in the [tbeptools](https://tbep-tech.github.io/tbeptools){target="_blank"} R software package.  Please see the [vignette](https://tbep-tech.github.io/tbeptools/articles/fib.html){target="_blank"} for a detailed overview of how you can use these functions on your own to work with the data. 

Questions and comments about the dashboard can be sent to [Marcus Beck](mailto:mbeck@tbep.org). Like this app? Share it on social media using the [\#TampaBayOpenSci](https://twitter.com/hashtag/TampaBayOpenSci?src=hashtag_click){target="_blank"} hashtag.  

<!-- Citation info here: [![DOI](https://zenodo.org/badge/589592689.svg)](https://zenodo.org/badge/latestdoi/589592689){target="_blank"} -->

<a rel='license' href='http://creativecommons.org/licenses/by/4.0/' target='_blank'><img alt='Creative Commons License' style='border-width:0' src='https://i.creativecommons.org/l/by/4.0/88x31.png' /></a>&nbsp;&nbsp;This website is licensed under a <a rel='license' href='http://creativecommons.org/licenses/by/4.0/' target='_blank'>Creative Commons Attribution 4.0 International License</a>.

</div>
<div class = "col-md-2"></div>
</div>

### METHODS

<div class = "row">
<div class = "col-md-2"></div>
<div class = "col-md-8">

#### How to understand and use the dashboard

</div>
<div class = "col-md-2"></div>
</div>

1 BAYWIDE
===========================================================

```{r}
column(12, 
  column(4,
    sliderInput('yrsel1', 'Select year:', min = 2001, max = maxyr, value = maxyr, step = 1, sep = '', width = '200%')
    ),
  column(8,
    selectInput('areasel1', 'Select area:', choices = areas1, selected = c('HB', 'OTB', 'MTB', 'LTB', 'BCB', 'MR'), width = '400%', multiple = T)
  )
)
```

Column {.tabset .tabset-fade data-width=275}
-----------------------------------------------------------------------

### REPORT CARD

```{r}
fillCol(flex = c(NA, 1),
  column(12,
    column(4,
      shinyWidgets::materialSwitch('segsel1', 'By bay segment?', value = T)
    )
  ),
  plotly::plotlyOutput('entmatrix')
)
```

### Using this tab

The report card and maps are based on *Enterococcus* cell concentratoins and can be subset by bay segment.  The map summary by year shows the same report card grade assigned to the entire bay segment and the individual station grade.  The map summary by year and month shows only the station category relative to the legend thresholds for samples identified as occuring during wet (rainy) or dry conditions. 

Column {.tabset .tabset-fade data-width=500}
-----------------------------------------------------------------------

### MAP BY YEAR

```{r}
leaflet::leafletOutput('entmapyr')
```

### MAP BY YEAR AND MONTH

```{r}
fillCol(flex = c(NA, 1),
  column(12,
    column(4, 
      shinyWidgets::sliderTextInput('mosel1', 'Select month:', choices = names(mos), selected = 'Jul', force_edges = T, grid = T, width = '200%')
    )
  ),
  leaflet::leafletOutput('entmap')
)
```

2 EPCHC
===========================================================

Column {.tabset .tabset-fade data-width=275}
-----------------------------------------------------------------------

### REPORT CARD

```{r}
plotly::plotlyOutput('fibmatrix')
```

### Using this tab

The report card is based on fecal coliform and cannot be subset by bay segment.  The map summaries are based on *Enterococcus* and *E. coli* data based on tidal or freshwater sites, respectively. 

Column {.tabset .tabset-fade data-width=500}
-----------------------------------------------------------------------

### MAP BY YEAR

### MAP BY YEAR AND MONTH

```{r}
fillCol(flex = c(NA, 1),
  column(12,
    column(4, 
        sliderInput('yrsel2', 'Select year:', min = 2001, max = maxyr, value = maxyr, step = 1, sep = '', width = '200%')
    ), 
    column(4, 
      shinyWidgets::sliderTextInput('mosel2', 'Select month:', choices = names(mos), selected = 'Jul', force_edges = T, grid = T, width = '200%')
    ),
    column(4,
      selectInput('areasel2', 'Select area:', choices = areas2, selected = c('Hillsborough River', 'Alafia River'), width = '200%', multiple = T)     
    )
  ),
  leaflet::leafletOutput('fibmap')
)
```

4 DATA DOWNLOADS
===========================================================

Column {.tabset .tabset-fade data-width=650}
-----------------------------------------------------------------------

### DOWNLOAD

```{r}
```

### METADATA

